---
title: "Hurricanes and Migration"
author: "Eugenio Paglino"
date: "\today"
output: 
  pdf_document:
    extra_dependencies: ["amsmath","natbib","csquotes","textcomp"]
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,echo=FALSE}

library(arrow)
library(zeallot)
library(sf)
library(USAboundaries)
library(tigris)
library(ggthemes)
library(tidyverse)

```

Setting the working directories.

```{r,echo=FALSE}

rm(list=ls())

here::i_am('secondYearPaper/R/finalDataCreation.Rmd')

inDir <- here::here('data','input')
outDirGen <- here::here('data','output')
outDir <- here::here('secondYearPaper','data','output')
figuresDir <- here::here('secondYearPaper','figures')
tablesDir <- here::here('secondYearPaper','tables')

```

Reading the migration data.

```{r,echo=FALSE}

migDataFull = data.frame(arrow::read_feather(here::here(outDirGen,'migDisFinDataCoastal.feather')))

```

We drop all observations referring to non-migrants as they are outside the scope of our analysis.

```{r,echo=FALSE}

minYear <- 1990
maxYear <- 2010
lag = 3

migData <- migDataFull %>%
  filter(origin!=destination,
         year>=minYear-lag,
         year<=maxYear)

```

We create lagged versions of the variables related to assistance, insurance payments and damage figures from SHELDUS.

```{r,echo=FALSE}

migData <- migData %>% 
  mutate(logSHELDUSDmgOrigin_1 = dplyr::lag(logSHELDUSDmgPCOrigin,n=1),
         logSHELDUSDmgOrigin_2 = dplyr::lag(logSHELDUSDmgPCOrigin,n=2),
         logSHELDUSDmgOrigin_3 = dplyr::lag(logSHELDUSDmgPCOrigin,n=3),
         logNFIPOrigin_1 = dplyr::lag(logNFIPPCOrigin,n=1),
         logNFIPOrigin_2 = dplyr::lag(logNFIPPCOrigin,n=2),
         logNFIPOrigin_3 = dplyr::lag(logNFIPPCOrigin,n=3),
         logAssistanceOrigin_1 = dplyr::lag(logAssistancePCOrigin,n=1),
         logAssistanceOrigin_2 = dplyr::lag(logAssistancePCOrigin,n=2),
         logAssistanceOrigin_3 = dplyr::lag(logAssistancePCOrigin,n=3),
         logSHELDUSDmgDest_1 = dplyr::lag(logSHELDUSDmgPCDest,n=1),
         logSHELDUSDmgDest_2 = dplyr::lag(logSHELDUSDmgPCDest,n=2),
         logSHELDUSDmgDest_3 = dplyr::lag(logSHELDUSDmgPCDest,n=3),
         logNFIPDest_1 = dplyr::lag(logNFIPPCDest,n=1),
         logNFIPDest_2 = dplyr::lag(logNFIPPCDest,n=2),
         logNFIPDest_3 = dplyr::lag(logNFIPPCDest,n=3),
         logAssistanceDest_1 = dplyr::lag(logAssistancePCDest,n=1),
         logAssistanceDest_2 = dplyr::lag(logAssistancePCDest,n=2),
         logAssistanceDest_3 = dplyr::lag(logAssistancePCDest,n=3))

```

We drop some problematic counties with non finite migration value (generated by a division by zero).

```{r, echo=F}

probDests <- unique(filter(migData,origin == '00000',
                            is.infinite(inMigRate))[,'destination'])

probOrigins <- unique(filter(migData,destination == '00000',
                              is.infinite(outMigRate))[,'origin'])

probCounties <- unique(c(probDests,probOrigins))

migData <- migData %>%
  filter(!(origin %in% probCounties),
         !(destination %in% probCounties),
         origin != '57003',
         destination != '57003')

```

```{r,echo=F}

nonflowCodes = c('00000','risk1','risk2','risk3','risk4',
                 'risk5','riskNA','anyRisk','99999')

flowsData <- migData %>%
  filter(!(origin %in% nonflowCodes),
         !(destination %in% nonflowCodes))

```

We generate two new list variables containing all hurricanes that hit a county in a given year. We perform this operation for both origin and destination counties, so that we know which hurricanes hit the starting point of a flow and which its destination.

```{r, echo=F}

migData <- migData %>% 
           group_by(origin) %>% 
           mutate(disOrigin = list(unique(na.omit(c(dis1Origin,dis2Origin,dis3Origin,dis4Origin))))) %>%
           ungroup()

migData <- migData %>% 
           group_by(origin) %>% 
           mutate(disDest = list(unique(na.omit(c(dis1Dest,dis2Dest,dis3Dest,dis4Dest))))) %>%
           ungroup()

```   

We create a vector with all hurricanes, reading it from a csv file

```{r, echo=F, message=F, warning=F, cache=T}

disasters <- read_csv(here::here(inDir,'utilities','disasters.csv'))
disasters <- as.vector(t(disasters))

noObsDis <- c("Hurricane Iniki 1992", "Hurricane Marilyn 1995", 
              "Hurricane Hortense 1996", "Hurricane Charley 2004", 
              "Tropical Storm Bonnie 2004", "Tropical Storm Maria 2011",
              "Hurricane Maria 2017")

# We remove Hurricanes for which we have no observations

disasters <- as.vector(setdiff(disasters,noObsDis))

years = as.vector(sapply(disasters,FUN = function(x) as.integer(substr(x,nchar(x)-3,nchar(x)))))

disasters <- disasters[(years <= maxYear) & (years >= minYear)]

```

We also create a dataframe with one row for each county-year reporting which hurricanes (if any) ever hit the county.

```{r, echo=F, cache=T, eval=F}

countyDF =  migData[!duplicated(migData[,c('origin','year')]), c('origin','year','disOrigin')]

names(countyDF) <- c('FIPS','year','disasters')

```

We then add two sets of dummy variables to this newly created dataframe. The first set tells us if a given hurricane ever hit the county (fixed over time), the second one tells us if a given hurricane hit the county in the last three years.

```{r, echo=F, cache=T, eval=F}

for (disaster in disasters) {
  
  hYear = as.integer(substr(disaster,nchar(disaster)-3,nchar(disaster)))
  hYears = seq(hYear,hYear+2,1)
  
  countyDF[paste0(gsub(' ', '', disaster),'Treat')] <- as.integer(
    apply(countyDF[,c('year','disasters')],
          MARGIN=1,
          FUN=function(x) {(disaster %in% x$disasters) &
                           (x$year %in% hYears)}))
  
  countyDF[gsub(' ', '', disaster)] <- as.integer(
    apply(countyDF[,'disasters'],
          MARGIN=1,
          FUN=function(x) {(disaster %in% x$disasters)}))
  
}

#aff_counts <- county_df[apply(county_df[,'hurricanes'],
#                        MARGIN=1,
#                        FUN=function(x) {hurricane %in% x[[1]]}),]$fips
  
```

We can now attach this important information to two newly created dataframes. One contains only in-migration flows (aggregated at the county level). The second one contains only out-migration flows (aggregate at the county level). These are the dataframes we will use in most of our analysis. The choice of moving to the county level rather than taking advantage of county-pairs is a consequence of the huge data dimension, that makes it difficult to analyse the full migration system in its entirety.

```{r, echo=F, cache=T}

outMigData <- migData %>%
  filter(destination %in% nonflowCodes)
  #left_join(countyDF,by=c('origin'='FIPS','year'='year'))

inMigData <- migData %>%
  filter(origin %in% nonflowCodes)
  #left_join(countyDF,by=c('destination'='FIPS','year'='year'))

```

As a final step, we create an alternative treatment variable that allows us to be more flexible when specifying the hurricanes impact. In particular, we let the impact be different for each of the three years after the event.

```{r, echo=F, cache=T}

addAltTreat <- function(data,disasters,hData,idVar,colsOut) {
  
  if (colsOut) {
    disasterCols = c()
  }
  
  for (disaster in disasters) {
  
    altVarName <- paste0(gsub(' ', '', disaster),'AltTreat')
    varName <- paste0(gsub(' ', '', disaster),'Treat')
    hYear = as.integer(substr(disaster,nchar(disaster)-3,nchar(disaster)))
    
    data[altVarName] <- ave(data[varName],data[idVar],FUN=cumsum)
    
    data[data$year > hYear+2,altVarName] <- 0
    
    if (colsOut) {
      disasterCols = c(disasterCols,varName,altVarName)
    }
    
  }
  
  if (colsOut) {
    disasterCols = c(sapply(disasters,FUN = function (x) gsub(' ', '', x)),disasterCols)  
  }
  
  if (colsOut) {
    return(list(data,data.frame(disasterCols)))
  } else {
    return(data)
  }
  
}

```

```{r, echo=F, cache=T, eval=F}

outMigData <- addAltTreat(outMigData,disasters,hData,'origin',colsOut=F)

```

```{r, echo=F, cache=T, eval=F}

c(inMigData,disasterCols) %<-% addAltTreat(inMigData,disasters,hData,'destination',colsOut=T)
disasterCols <- as.vector(t(disasterCols))

```

We ensure that the data starts from the first year with available data.

```{r, echo=F, cache=T}
#rm(county_df)
#rm(mig_hurricanes)

outMigData <- outMigData %>% 
  filter(year>=minYear) %>%
  select(-(dplyr::ends_with('Dest',ignore.case = F))) %>%
  select(-(dplyr::contains('Dest_',ignore.case = F))) %>%
  select(-disOrigin)
  
inMigData <- inMigData %>%
  filter(year>=minYear) %>%
  select(-(dplyr::ends_with('Origin',ignore.case = F))) %>%
  select(-(dplyr::contains('Origin_',ignore.case = F))) %>%
  select(-disDest)

```

```{r, echo=F, cache=T}

outMigData <- outMigData %>%
  rename_with( ~ gsub('Origin', '', .x, fixed = TRUE))

inMigData <- inMigData %>%
  rename_with( ~ gsub('Dest', '', .x, fixed = TRUE))

```

```{r, echo=F, cache=T}
#rm(county_df)
#rm(mig_hurricanes)

outMigData <- outMigData %>% 
  mutate(treat = factor(treat,
                        levels = c(0,1),
                        labels = c('No','Yes')),
         altTreat = factor(altTreat,
                           levels = c(0,1,2,3,4),
                           labels = c('No Hurricane','Hurricane',
                                      'Hurricane 1 Year Ago',
                                      'Hurricane 2 Years Ago',
                                      'Hurricane 3 Years Ago')))
  
inMigData <- inMigData %>% 
  mutate(treat = factor(treat,
                        levels = c(0,1),
                        labels = c('No','Yes')),
         altTreat = factor(altTreat,
                           levels = c(0,1,2,3,4),
                           labels = c('No Hurricane','Hurricane',
                                      'Hurricane 1 Year Ago',
                                      'Hurricane 2 Years Ago',
                                      'Hurricane 3 Years Ago')))

```

```{r, echo=F, cache=T}

SVIData <- read_sf(here::here(inDir,'SVI2014_US_CNTY','SVI2014_US_CNTY.shp'))
SVIData <- as_tibble(SVIData) %>%
  rename(FIPSCode = FIPS) %>%
  select(FIPSCode,RPL_THEME1,RPL_THEME2,RPL_THEME3,RPL_THEME4,RPL_THEMES) %>%
  rename(socioEcon = RPL_THEME1,
         houseComp = RPL_THEME2,
         minorityStat = RPL_THEME3,
         housing = RPL_THEME4,
         SVI = RPL_THEMES)

```

```{r, echo=F, cache=T}
#rm(county_df)
#rm(mig_hurricanes)

outMigData <- outMigData %>%
  left_join(SVIData,by=c('origin'='FIPSCode'))

inMigData <- inMigData %>%
  left_join(SVIData,by=c('destination'='FIPSCode'))

```

```{r, echo=FALSE, warning=F, message=F, eval=F}

counties <- us_counties()
# Transform to Albers for making map of US
counties <- st_transform(counties, 5070)

counties <- counties %>%
  select(geoid,geometry) %>%
  rename(FIPSCode = geoid) 

counties <- tigris::shift_geometry(counties)

```

```{r, echo=FALSE, warning=F, message=F, eval=F}

SVIData <- counties %>%
  left_join(SVIData,by=c('FIPSCode'))

```

```{r, echo=FALSE, warning=F, message=F, fig.height=12, fig.width=15, eval=F}

SVIData %>%
  ggplot() +
    geom_sf(mapping=aes(fill = RPL_THEMES),
            color = "gray30", size = 0.05) +
    scale_fill_scico(palette = 'vikO') +
    labs(fill='Social Vulnerability Index') +
    coord_sf() +
    theme_map() +
    theme(legend.position = 'bottom')

```

Ready to save the data

```{r,echo=F}

save(outMigData,file=here::here(outDir,'outMigData.RData'))
save(inMigData,file=here::here(outDir,'inMigData.RData'))

```