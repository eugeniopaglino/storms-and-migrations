---
title: "Hurricanes and Migration"
author: "Eugenio Paglino"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      warning=F,
                      message)
```

```{r,echo=FALSE}
library(arrow)
library(zeallot)
library(sf)
library(USAboundaries)
library(tigris)
library(ggthemes)
library(tidyverse)
```

Setting the working directories.

```{r,echo=FALSE}
rm(list=ls())

here::i_am('secondYearPaper/R/finalDataCreation.Rmd')

inDir <- here::here('data','input')
outDirGen <- here::here('data','output')
outDir <- here::here('secondYearPaper','data','output')
figuresDir <- here::here('secondYearPaper','figures')
tablesDir <- here::here('secondYearPaper','tables')
```

Reading the migration data.

```{r,echo=FALSE}
migDataFull = data.frame(arrow::read_feather(here::here(outDirGen,'migDisFinDataCoastal.feather')))
```

We drop all observations referring to non-migrants as they are outside the scope of our analysis.

```{r,echo=FALSE}
maxYear <- 2010
minYear <- 1988

migData <- migDataFull %>%
  filter(origin!=destination,
         year<=maxYear)

rm(migDataFull)
```

We drop some problematic counties with non finite migration value (generated by a division by zero).

```{r, echo=F}
probDests <- unique(filter(migData,origin == '00000',
                            is.infinite(inMigRate))[,'destination'])

probOrigins <- unique(filter(migData,destination == '00000',
                              is.infinite(outMigRate))[,'origin'])

probCounties <- unique(c(probDests,probOrigins))

migData <- migData %>%
  filter(!(origin %in% probCounties),
         !(destination %in% probCounties),
         origin != '57003',
         destination != '57003')
```

```{r,echo=F}
nonflowCodes = c('00000','risk1','risk2','risk3','risk4',
                 'risk5','riskNA','anyRisk','99999')

flowsData <- migData %>%
  filter(!(origin %in% nonflowCodes),
         !(destination %in% nonflowCodes))
```

We generate two new list variables containing all hurricanes that hit a county in a given year. We perform this operation for both origin and destination counties, so that we know which hurricanes hit the starting point of a flow and which its destination.

```{r, echo=F}
migData <- migData %>% 
           group_by(origin) %>% 
           mutate(disOrigin = list(unique(na.omit(c(dis1Origin,dis2Origin,dis3Origin,dis4Origin))))) %>%
           ungroup()

migData <- migData %>% 
           group_by(origin) %>% 
           mutate(disDest = list(unique(na.omit(c(dis1Dest,dis2Dest,dis3Dest,dis4Dest))))) %>%
           ungroup()
```   

We can now attach this important information to two newly created dataframes. One contains only in-migration flows (aggregated at the county level). The second one contains only out-migration flows (aggregate at the county level). These are the dataframes we will use in most of our analysis. The choice of moving to the county level rather than taking advantage of county-pairs is a consequence of the huge data dimension, that makes it difficult to analyse the full migration system in its entirety.

```{r, echo=F, cache=T}
outMigData <- migData %>%
  filter(destination %in% nonflowCodes) %>%
  distinct(origin,destination,year,.keep_all = T)
  #left_join(countyDF,by=c('origin'='FIPS','year'='year'))

inMigData <- migData %>%
  filter(origin %in% nonflowCodes) %>%
  distinct(origin,destination,year,.keep_all = T)
  #left_join(countyDF,by=c('destination'='FIPS','year'='year'))

rm(migData)
```

We ensure that the data starts from the first year with available data.

```{r, echo=F, cache=T}
#rm(county_df)
#rm(mig_hurricanes)
outMigData <- outMigData %>% 
  filter(year>=minYear) %>%
  select(-(dplyr::ends_with('Dest',ignore.case = F))) %>%
  select(-(dplyr::contains('Dest_',ignore.case = F))) %>%
  select(-disOrigin)
  
inMigData <- inMigData %>%
  filter(year>=minYear) %>%
  select(-(dplyr::ends_with('Origin',ignore.case = F))) %>%
  select(-(dplyr::contains('Origin_',ignore.case = F))) %>%
  select(-disDest)
```

```{r, echo=F, cache=T}
outMigData <- outMigData %>%
  rename_with( ~ gsub('Origin', '', .x, fixed = TRUE))

inMigData <- inMigData %>%
  rename_with( ~ gsub('Dest', '', .x, fixed = TRUE))
```

```{r, echo=F, cache=T}
#rm(county_df)
#rm(mig_hurricanes)
outMigData <- outMigData %>% 
  mutate(treat = factor(treat,
                        levels = c(0,1),
                        labels = c('No','Yes')))
  
inMigData <- inMigData %>% 
  mutate(treat = factor(treat,
                        levels = c(0,1),
                        labels = c('No','Yes')))
```

```{r}
add_county_year_disasters <- function(data,idVar) {
  
  data <- data %>%
    mutate(disasters = pmap(
                             .l=list(dis1,dis2,dis3,dis4),
                             .f=function(x,y,z,w) {
                                  disVec <- c(x,y,z,w)
                                  disVec <- disVec[!is.na(disVec)]
                                  return(disVec)
                                }
                             )) %>%
    group_by(origin,destination) %>%
    mutate(disastersL1 = lag(disasters,1),
           disastersL2 = lag(disasters,2)) %>%
    ungroup() %>%
    mutate(disasters = pmap(
                             .l=list(disasters,disastersL1,disastersL2),
                             .f=function(x,y,z) {
                                  disVec <- c(x,y,z)
                                  disVec <- unique(disVec[!is.na(disVec)])
                                  return(disVec)
                                }
                             ),
            ) %>%
    select(-disastersL1:disastersL2)
  
  return(data)
}

outMigData <- outMigData %>%
  add_county_year_disasters()

inMigData <- inMigData %>%
  add_county_year_disasters()
```

```{r}
countyStormsOut <- outMigData %>%
  pull(disasters)
countyStormsIn <- inMigData %>%
  pull(disasters)

storms <- reduce(countyStormsOut,union)
identifiableStorms <- list()

for (storm in storms) {
  
  if (!any(map(identifiableStorms,function(x) storm %in% x))) {
    
    intersectingStorms <- c(storm)
    identifiableStorms[[storm]]  <- c('Test')
    
    while(!setequal(intersectingStorms,identifiableStorms[[storm]])) {
      
      identifiableStorms[[storm]] <- intersectingStorms
      
      for (countyStorm in countyStormsOut) {
        
        if (length(intersect(intersectingStorms,countyStorm))>0) {
          
          intersectingStorms <- union(intersectingStorms,countyStorm)
          
        }
      }
    }
  }  
}
```

```{r}
assign_identifiable_hurricane <- function(storms,identifiableStorms) {
  
  if (length(storms) == 0) {
    return('')
  }
  
  i <- 1
  while (length(intersect(storms,identifiableStorms[[i]])) == 0) {
    i <- i + 1
  }

  return(names(identifiableStorms[i]))  
}
```

```{r}
stormGroupOut <- sapply(countyStormsOut,
                        function(x) {
                          assign_identifiable_hurricane(x,identifiableStorms)
                          })
outMigData <- outMigData %>%
  mutate(stormGroup = stormGroupOut)

stormGroupIn <- sapply(countyStormsIn,
                       function(x) {
                         assign_identifiable_hurricane(x,identifiableStorms)
                         })
inMigData <- inMigData %>%
  mutate(stormGroup = stormGroupIn)
```

```{r, echo=F, cache=T}
SVIData14 <- read_sf(here::here(inDir,'SVI','SVI2014_US_CNTY','SVI2014_US_CNTY.shp'))
SVIData14 <- as_tibble(SVIData14) %>%
  rename(FIPSCode = FIPS) %>%
  select(FIPSCode,RPL_THEME1,RPL_THEME2,RPL_THEME3,RPL_THEME4,RPL_THEMES) %>%
  rename(socioEcon = RPL_THEME1,
         houseComp = RPL_THEME2,
         minorityStat = RPL_THEME3,
         housing = RPL_THEME4,
         SVI = RPL_THEMES)
```

```{r}
SVIData <- read_csv(here::here(inDir,'SVI','SVI_2000_US_county.csv'))
SVIData <- as_tibble(SVIData) %>%
  rename(FIPSCode = STCOFIPS) %>%
  select(FIPSCode,USG1TP,USG2TP,USG3TP,USG4TP,USTP) %>%
  rename(socioEcon = USG1TP,
         houseComp = USG2TP,
         minorityStat = USG3TP,
         housing = USG4TP,
         SVI = USTP)
```

```{r, echo=F, cache=T}
#rm(county_df)
#rm(mig_hurricanes)
outMigData <- outMigData %>%
  left_join(SVIData,by=c('origin'='FIPSCode'))

inMigData <- inMigData %>%
  left_join(SVIData,by=c('destination'='FIPSCode'))
```

```{r}
outMigData <- outMigData %>%
  filter(!(destination %in% c('00000','99999','riskNA','anyRisk')),
         year<=2010) %>%
  distinct(origin,destination,year,.keep_all = T)

completeData <- crossing(origin = unique(pull(outMigData,origin)),
                         destination = unique(pull(outMigData,destination)),
                         year = 1990:2010)

originData <- outMigData %>%
  distinct(origin,year,.keep_all = T) %>%
  select(origin,originName,year,treat,altTreat,pop,
         dis1,dis2,dis3,dis4,disasters,stormGroup,
         logSHELDUSDmgPC,logCumSHELDUSDmgPC,
         logNFIPPC,logCumNFIPPC,
         logAssistancePC,logCumAssistancePC,
         logPopCensus,logPopDensity,
         pctYoung,pctOld,pctBlack,pctWhite,
         socioEcon,houseComp,minorityStat,housing,SVI)

outMigData <- completeData %>%
  left_join(outMigData %>%
              select(origin,destination,year,individuals) %>%
              group_by(origin,year),
            by=c('origin','destination','year')) %>%
  mutate(individualsImp = floor(rbeta(nrow(completeData),1,1)*9+1),
         individuals = if_else(is.na(individuals) | individuals==0,
                               individualsImp,
                               individuals))

outMigData <- outMigData %>%
  group_by(origin,year) %>%
  summarize(individuals = sum(individuals)) %>%
  ungroup() %>%
  mutate(destination = 'total') %>%
  bind_rows(outMigData)

outMigData <- outMigData %>%
  left_join(originData,by=c('origin','year'))
```

```{r}
# Basic Check
outMigData %>%
  filter(destination != 'total') %>%
  summarise(individuals = sum(individuals)) %>%
  ungroup()

outMigData %>%
  filter(destination == 'total') %>%
  summarise(individuals = sum(individuals)) %>%
  ungroup()
```

```{r}
inMigData <- inMigData %>%
  filter(!(origin %in% c('00000','99999','riskNA','anyRisk')),
         year<=2010) %>%
  distinct(destination,origin,year,.keep_all = T)

completeData <- crossing(destination = unique(pull(inMigData,destination)),
                         origin = unique(pull(inMigData,origin)),
                         year = 1990:2010)

destinationData <- inMigData %>%
  distinct(destination,year,.keep_all = T) %>%
  select(destination,destName,year,treat,altTreat,pop,
         dis1,dis2,dis3,dis4,disasters,stormGroup,
         logSHELDUSDmgPC,logCumSHELDUSDmgPC,
         logNFIPPC,logCumNFIPPC,
         logAssistancePC,logCumAssistancePC,
         logPopCensus,logPopDensity,
         pctYoung,pctOld,pctBlack,pctWhite,
         socioEcon,houseComp,minorityStat,housing,SVI)

inMigData <- completeData %>%
  left_join(inMigData %>%
              select(destination,origin,year,individuals) %>%
              group_by(destination,year),
            by=c('destination','origin','year')) %>%
  mutate(individualsImp = floor(rbeta(nrow(completeData),1,1)*9+1),
         individuals = if_else(is.na(individuals) | individuals==0,
                               individualsImp,
                               individuals))

inMigData <- inMigData %>%
  group_by(destination,year) %>%
  summarize(individuals = sum(individuals)) %>%
  ungroup() %>%
  mutate(origin = 'total') %>%
  bind_rows(inMigData)

inMigData <- inMigData %>%
  left_join(destinationData,by=c('destination','year'))
```

```{r}
# Basic Check
inMigData %>%
  filter(origin != 'total') %>%
  summarise(individuals = sum(individuals)) %>%
  ungroup()

inMigData %>%
  filter(origin == 'total') %>%
  summarise(individuals = sum(individuals)) %>%
  ungroup()
```

Ready to save the data

```{r,echo=F}

save(outMigData,file=here::here(outDir,'outMigData.RData'))
save(inMigData,file=here::here(outDir,'inMigData.RData'))

```